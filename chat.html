<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Stina AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/theme.css" />
    <link rel="stylesheet" href="src/styles/sidebar.css" />
    <link rel="stylesheet" href="src/styles/chat.css" />
    <link rel="stylesheet" href="src/styles/components/inputs.css" />
    <link rel="stylesheet" href="src/styles/components/modals.css" />
    <link rel="stylesheet" href="src/styles/markdown.css" />
  </head>
  <body class="has-navbar-fixed-top">
    <!-- Top Navigation -->
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="sidebarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item">
            <a id="new-chat-btn" class="button is-link" data-translation-key="newChat">
              <span class="icon"><i class="fas fa-plus"></i></span>
              <span></span>
            </a>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <button id="settings-btn" class="button is-light" data-translation-key="settings">
              <span class="icon"><i class="fas fa-cog"></i></span>
              <span></span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="columns is-gapless is-mobile" style="height: calc(100vh - 52px); overflow: hidden;">
      <!-- Sidebar -->
      <aside class="column is-2 is-hidden-mobile sidebar" id="sidebarMenu" style="height: 100%; overflow-y: auto;">
        <div class="menu-container">
          <ul class="menu-list" id="chat-list"></ul> 
        </div>
      </aside>

      <!-- Main Chat Area -->
      <main class="column is-12-mobile is-10-desktop section" style="height: 100%; overflow: hidden;">
        <div class="container is-fluid" style="height: 100%; display: flex; flex-direction: column; align-items: center;">
          <!-- Centered Container for Chat Content -->
          <div class="container is-fluid" style="flex: 1; display: flex; flex-direction: column; height: 100%;">
          <div id="chat-history" class="box content" style="overflow-y: auto;"></div>
          <!-- Message Input Box -->
          <div class="message-input-container">
            <!-- Input Box -->
            <div
              id="user-input"
              class="input-box"
              contenteditable="true"
              data-placeholder=""
            ></div>

            <!-- Toolbar Below the Input -->
            <div class="toolbar">
              <!-- Left Side of Toolbar -->
              <div class="left-toolbar">
                <!-- Model Selection -->
                <div class="select-container">
                  <select id="model-select"></select>
                </div>
                <!-- Instruction Selector and Edit Button -->
                <div class="instruction-selector-container" id="instructions-group" style="display: none;">
                  <div class="select-container">
                    <select id="instructions-select"></select>
                  </div>
                  <button 
                    id="edit-instruction-btn" 
                    class="button is-transparent is-small" 
                    style="display: none;"
                  >
                    Redigera
                  </button>
                </div>
              </div>
              <!-- Right Side of Toolbar -->
              <!-- Send Button -->
              <button id="send-btn" class="send-button">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
      </div>
      </main>
    </div>


    <!-- Custom Modal -->
    <div id="custom-modal" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title" id="custom-modal-title">Title</p>
          <button id="custom-modal-close" class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body" id="custom-modal-body">
          <!-- Message content will be injected here -->
        </section>
        <footer class="modal-card-foot" id="custom-modal-footer">
          <!-- Buttons will be injected here -->
        </footer>
      </div>
    </div>

    <!-- Include Marked.js and DOMPurify via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.7/dist/purify.min.js"></script>

    <!-- Include highlight.js via CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <!-- Include Config -->
    <script src="config.js"></script>

    <!-- Include Instructions -->
    <script src="src/default_instructions.js"></script>

    <!-- Optionally Include Additional Instructions -->
    <script>
      // Function to dynamically load instructions.js if it exists
      (function() {
        var script = document.createElement('script');
        script.src = 'instructions.js';
        script.onload = function() {
          console.log('instructions.js has been loaded.');
        };
        script.onerror = function() {
          console.warn('instructions.js could not be loaded, continuing without additional instructions.');
        };
        document.head.appendChild(script);
      })();
    </script>

    <!-- Define mergeInstructions function -->
    <script>
      function mergeInstructions() {
        // Get customInstructions from localStorage
        const customInstructions = JSON.parse(localStorage.getItem("customInstructions")) || [];

        // Log values for debugging
        console.log("Before merging:");
        console.log("defaultInstructions:", window.defaultInstructions);
        console.log("additionalInstructions:", window.additionalInstructions);
        console.log("customInstructions:", customInstructions);

        // Combine all instructions
        window.instructions = (window.defaultInstructions || [])
          .concat(window.additionalInstructions || [])
          .concat(customInstructions);

        // Log merged result
        console.log("After merging - window.instructions:", window.instructions);

        // Initialize the app after instructions are merged
        ControllerModule.initializeApp();
      }
    </script>

    <!-- Dynamically load instructions.js and call mergeInstructions -->
    <script>
      (function() {
        var script = document.createElement('script');
        script.src = 'instructions.js';
        script.onload = function() {
          console.log('instructions.js has been loaded.');
          mergeInstructions();
        };
        script.onerror = function() {
          console.warn('instructions.js could not be loaded, continuing without additional instructions.');
          mergeInstructions();
        };
        document.head.appendChild(script);
      })();
    </script>

    <!-- Include Translations -->
    <script src="src/translations.js"></script>

    <!-- Include Default Models -->
    <script src="src/default_models.js"></script>

    <!-- Function to merge models -->
    <script>
      function mergeModels() {
        const customModels = JSON.parse(localStorage.getItem("customModels")) || {};

        // Combine all models
        window.models = {
          ...window.defaultModels,
          ...window.additionalModels,
          ...customModels
        };

        console.log("Efter sammanslagning - window.models:", window.models);

        // Initialize app after models are merged
        ControllerModule.initializeApp();
      }
    </script>

    <!-- Dynamically load models.js and call mergeModels -->
    <script>
      (function() {
        var script = document.createElement('script');
        script.src = 'models.js';
        script.onload = function() {
          console.log('models.js har laddats.');
          mergeModels();
        };
        script.onerror = function() {
          console.warn('models.js kunde inte laddas, forts√§tter utan ytterligare modeller.');
          window.additionalModels = {};
          mergeModels();
        };
        document.head.appendChild(script);
      })();
    </script>

    <!-- Application Modules -->
    <script src="src/storage.js"></script>
    <script src="src/config.js"></script>
    <script src="src/translation.js"></script>
    <script src="src/api.js"></script>
    <script src="src/chat.js"></script>
    <script src="src/message.js"></script>
    <script src="src/rendering.js"></script>
    <script src="src/events.js"></script>
    <script src="src/modal.js"></script>
    <script src="src/controller.js"></script>

  </body>
</html>
